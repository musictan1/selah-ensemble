<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>회원 관리 - 셀라앙상블 찬양단</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #fff;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-radius: 5px;
        }
        
        .message {
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 5px;
            background-color: #d4edda;
            color: #155724;
            display: none;
        }
        
        .error {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .user-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .user-table th, .user-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .user-table th {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        
        .user-delete-btn {
            padding: 5px 10px;
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        
        .user-role-select {
            padding: 5px;
            border-radius: 3px;
            border: 1px solid #ced4da;
        }
        
        /* 관리자 메뉴 스타일 */
        .admin-menu {
            display: flex;
            gap: 10px;
            list-style: none;
            margin: 0;
            padding: 0;
            margin-bottom: 20px;
        }
        
        .admin-menu li a {
            display: block;
            padding: 10px 15px;
            background-color: #007bff;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        
        .admin-menu li a:hover {
            background-color: #0056b3;
        }
        
        /* 관리자 콘텐츠 섹션 스타일 */
        .admin-content-section {
            margin-top: 20px;
        }
        
        /* 관리자 테이블 공통 스타일 */
        .admin-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .admin-table th, .admin-table td {
            padding: 12px 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
            font-size: 14px;
        }
        
        .admin-table th {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        
        /* 문의 관리 스타일 */
        .view-inquiry-btn {
            padding: 5px 10px;
            background-color: #17a2b8;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        
        .delete-inquiry-btn {
            padding: 5px 10px;
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            margin-left: 5px;
        }
        
        .status-select {
            padding: 5px;
            border-radius: 3px;
            border: 1px solid #ced4da;
            min-width: 100px;
        }
        
        /* 상태별 색상 */
        .status-new {
            background-color: #e2f3f5;
        }
        
        .status-processing {
            background-color: #fff6dd;
        }
        
        .status-completed {
            background-color: #d4edda;
        }
        
        /* 모달 스타일 */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.7);
        }
        
        .modal-content {
            position: relative;
            background-color: #fefefe;
            margin: 5% auto;
            padding: 0;
            border-radius: 5px;
            width: 80%;
            max-width: 800px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            animation: modalopen 0.3s;
        }
        
        @keyframes modalopen {
            from {opacity: 0; transform: translateY(-50px);}
            to {opacity: 1; transform: translateY(0);}
        }
        
        .modal-header {
            padding: 15px 20px;
            background-color: #f8f9fa;
            border-bottom: 1px solid #ddd;
            border-radius: 5px 5px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            margin: 0;
            color: #333;
        }
        
        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover, .close:focus {
            color: #000;
            text-decoration: none;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .modal-footer {
            padding: 15px 20px;
            background-color: #f8f9fa;
            border-top: 1px solid #ddd;
            border-radius: 0 0 5px 5px;
            display: flex;
            justify-content: flex-end;
        }
        
        .modal-delete-btn {
            padding: 8px 15px;
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .inquiry-details p {
            margin: 10px 0;
            line-height: 1.5;
        }
        
        .inquiry-message {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        
        .inquiry-message h4 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #333;
        }
        
        .message-content {
            line-height: 1.6;
            white-space: pre-line;
        }
        
        /* 게시글 관리 스타일 */
        .view-post-btn {
            padding: 5px 10px;
            background-color: #17a2b8;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        
        .delete-post-btn {
            padding: 5px 10px;
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            margin-left: 5px;
        }
        
        .post-content {
            margin: 20px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            white-space: pre-line;
        }
        
        .comments-section {
            margin-top: 30px;
            border-top: 1px solid #ddd;
            padding-top: 20px;
        }
        
        .comment {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .comment-date {
            font-size: 0.85em;
            color: #6c757d;
        }
        
        /* 파일 관리 스타일 */
        .file-section {
            margin-bottom: 30px;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            background-color: #f9f9f9;
        }
        
        .file-section h5 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #333;
        }
        
        .delete-file-btn {
            padding: 5px 10px;
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        
        .admin-menu-list button {
            display: block;
            width: 100%;
            text-align: left;
            padding: 15px;
            background: #f8f9fa;
            border: none;
            border-radius: 5px;
            margin-bottom: 10px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .admin-menu-list button:hover {
            background: #e9ecef;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .admin-menu-list button.active {
            background: #007bff;
            color: white;
        }
        
        /* 권한 배지 스타일 */
        .permission-badge {
            display: inline-block;
            padding: 3px 8px;
            margin: 2px;
            border-radius: 3px;
            font-size: 0.8em;
            font-weight: bold;
        }
        
        .permission-badge.admin {
            background-color: #dc3545;
            color: white;
        }
        
        .permission-badge.special {
            background-color: #fd7e14;
            color: white;
        }
        
        .permission-badge.regular {
            background-color: #28a745;
            color: white;
        }
        
        .permission-badge.new {
            background-color: #17a2b8;
            color: white;
        }
        
        /* 메뉴 권한 관리 스타일 */
        .menu-permissions-container {
            margin-top: 20px;
        }
        
        .role-menu-grid {
            display: grid;
            grid-template-columns: 150px 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .role-name {
            font-weight: bold;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
            display: flex;
            align-items: center;
        }
        
        .menu-checkboxes {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .menu-checkbox-item {
            background-color: #f8f9fa;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }
        
        .menu-checkbox-item:hover {
            background-color: #e9ecef;
        }
        
        .menu-checkbox-item.selected {
            background-color: #28a745;
            color: white;
        }
        
        .menu-checkbox-item.locked {
            background-color: #6c757d;
            color: white;
            cursor: not-allowed;
        }
        
        .save-permissions-btn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
        }
        
        .save-permissions-btn:hover {
            background-color: #0069d9;
        }
    </style>
</head>
<body>
    <header>
        <nav>
            <div class="logo">
                <a href="index.html"><img src="IMAGES/logo.png" alt="셀라앙상블 로고"></a>
            </div>
            <ul class="nav-menu">
                <li><a href="index.html#about">소개</a></li>
                <li><a href="join.html">회원가입</a></li>
                <li><a href="performances.html">찬양사역영상</a></li>
                <li><a href="music.html">음악파일</a></li>
                <li><a href="scores.html">악보파일</a></li>
                <li><a href="board.html">게시판</a></li>
                <li><a href="schedule.html">일정관리</a></li>
                <li><a href="inquiry.html">찬양사역문의</a></li>
                <li><a href="sponsor.html">후원계좌</a></li>
                <li><a href="youtube.html">유튜브</a></li>
                <li><a href="https://www.instagram.com/selahensemble1/" target="_blank">인스타그램</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <section class="section">
            <h2>회원 관리</h2>
            <div class="admin-container">
                <div id="message" class="message" style="display: none;"></div>
                <div class="admin-section">
                    <h3>관리자 메뉴</h3>
                    <div class="admin-menu-list">
                        <button id="show-users-btn" class="active">회원 관리</button>
                        <button id="show-posts-btn">게시글 관리</button>
                        <button id="show-files-btn">파일 관리</button>
                        <button id="show-inquiries-btn">문의 관리</button>
                        <button id="show-menu-permissions-btn">메뉴 권한 관리</button>
                    </div>
                </div>
                <div id="users-section" class="admin-content-section">
                    <h3>회원 관리</h3>
                    <div id="users-container">
                        <table class="user-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>이름</th>
                                    <th>이메일</th>
                                    <th>전화번호</th>
                                    <th>등급</th>
                                    <th>권한</th>
                                    <th>가입일</th>
                                    <th>관리</th>
                                </tr>
                            </thead>
                            <tbody id="userList">
                                <!-- 사용자 목록이 여기에 동적으로 추가됩니다 -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div id="posts-section" class="admin-content-section">
                    <h3>게시글 관리</h3>
                    <div id="posts-container">
                        <!-- 게시글 목록이 여기에 동적으로 추가됩니다 -->
                        <p>로딩 중...</p>
                    </div>
                </div>
                <div id="files-section" class="admin-content-section">
                    <h3>파일 관리</h3>
                    <div id="files-container">
                        <!-- 파일 목록이 여기에 동적으로 추가됩니다 -->
                        <p>로딩 중...</p>
                    </div>
                </div>
                <div id="inquiries-section" class="admin-content-section">
                    <h3>문의 관리</h3>
                    <div id="inquiries-container">
                        <!-- 문의 목록이 여기에 동적으로 추가됩니다 -->
                        <p>로딩 중...</p>
                    </div>
                </div>
                <div id="menu-permissions-section" class="admin-section" style="display: none;">
                    <h2>메뉴 권한 관리</h2>
                    <p>각 회원 등급별로 접근할 수 있는 메뉴를 설정합니다.</p>
                    
                    <div class="menu-permissions-container">
                        <div id="role-menu-permissions"></div>
                        
                        <button id="save-menu-permissions" class="save-permissions-btn">
                            <i class="fas fa-save"></i> 메뉴 권한 저장하기
                        </button>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer>
        <div class="footer-content">
            <p>&copy; 2024 셀라앙상블 찬양단. All rights reserved.</p>
        </div>
    </footer>

    <script>
        // 페이지 로드 시 인증 확인
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                const response = await fetch('/api/check-auth');
                const data = await response.json();
                
                if (!data.is_authenticated) {
                    showMessage('로그인이 필요합니다.', 'error');
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 2000);
                    return;
                }
                
                if (data.user.role !== 'admin') {
                    showMessage('운영자만 접근할 수 있습니다.', 'error');
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 2000);
                    return;
                }
                
                // 인증된 운영자인 경우 사용자 목록 로드
                loadUsers();
                
                // 다른 데이터도 미리 로드
                loadPosts();
                loadFiles();
                loadInquiries();
                loadMenuPermissions();
            } catch (error) {
                showMessage('인증 확인 중 오류가 발생했습니다.', 'error');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
            }
        });

        // 사용자 등급 정의
        const USER_ROLES = {
            'admin': '운영자',
            'special': '특별회원',
            'regular': '일반회원',
            'new': '신입회원'
        };

        // 각 등급별 권한 정의
        const USER_PERMISSIONS = {
            'admin': ['회원관리', '게시글삭제', '파일관리', '전체조회'],
            'special': ['게시글삭제', '파일관리', '전체조회'],
            'regular': ['전체조회'],
            'new': ['기본조회']
        };

        // 사용자 목록 로드 함수
        async function loadUsers() {
            try {
                const response = await fetch('/api/users');
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || '사용자 목록을 불러올 수 없습니다.');
                }
                const users = await response.json();
                
                if (users.length === 0) {
                    const userList = document.getElementById('userList');
                    userList.innerHTML = '<tr><td colspan="8" style="text-align: center;">등록된 회원이 없습니다.</td></tr>';
                    return;
                }
                
                displayUsers(users);
            } catch (error) {
                console.error('사용자 목록 로드 오류:', error);
                showMessage(error.message, 'error');
            }
        }

        // 사용자 목록 표시 함수
        function displayUsers(users) {
            const userList = document.getElementById('userList');
            userList.innerHTML = '';

            users.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${user.id}</td>
                    <td>${user.name}</td>
                    <td>${user.email}</td>
                    <td>${user.phone}</td>
                    <td>
                        <select class="role-select" data-user-id="${user.id}" ${user.role === 'admin' ? 'disabled' : ''}>
                            ${Object.entries(USER_ROLES).map(([key, value]) => 
                                `<option value="${key}" ${user.role === key ? 'selected' : ''}>${value}</option>`
                            ).join('')}
                        </select>
                    </td>
                    <td>
                        ${USER_PERMISSIONS[user.role].map(permission => 
                            `<span class="permission-badge ${user.role}">${permission}</span>`
                        ).join('')}
                    </td>
                    <td>${user.created_at}</td>
                    <td>
                        <button class="update-btn" onclick="updateUserRole(${user.id})" ${user.role === 'admin' ? 'disabled' : ''}>변경</button>
                        <button class="delete-btn" onclick="deleteUser(${user.id})" ${user.role === 'admin' ? 'disabled' : ''}>삭제</button>
                    </td>
                `;
                userList.appendChild(row);
            });
        }

        // 사용자 등급 변경 함수
        async function updateUserRole(userId) {
            try {
                const roleSelect = document.querySelector(`.role-select[data-user-id="${userId}"]`);
                const newRole = roleSelect.value;
                
                const response = await fetch(`/api/users/${userId}/role`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ role: newRole })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || '사용자 등급 변경에 실패했습니다.');
                }
                
                showMessage('사용자 등급이 변경되었습니다.', 'success');
                await loadUsers(); // 목록 새로고침
            } catch (error) {
                console.error('사용자 등급 변경 오류:', error);
                showMessage(error.message, 'error');
            }
        }
        
        // 사용자 삭제 함수
        async function deleteUser(userId) {
            try {
                if (!confirm('정말로 이 사용자를 삭제하시겠습니까?')) {
                    return;
                }
                
                const response = await fetch(`/api/users/${userId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || '사용자 삭제에 실패했습니다.');
                }
                
                showMessage('사용자가 삭제되었습니다.', 'success');
                await loadUsers(); // 목록 새로고침
            } catch (error) {
                console.error('사용자 삭제 오류:', error);
                showMessage(error.message, 'error');
            }
        }
        
        // 메시지 표시 함수
        function showMessage(message, type) {
            const messageElement = document.getElementById('message');
            messageElement.textContent = message;
            messageElement.className = `message ${type}`;
            messageElement.style.display = 'block';
            
            // 3초 후 메시지 숨기기
            setTimeout(() => {
                messageElement.style.display = 'none';
            }, 3000);
        }

        document.addEventListener('DOMContentLoaded', function() {
            // 관리자 메뉴 초기화
            const showUsersBtn = document.getElementById('show-users-btn');
            const showPostsBtn = document.getElementById('show-posts-btn');
            const showFilesBtn = document.getElementById('show-files-btn');
            const showInquiriesBtn = document.getElementById('show-inquiries-btn');
            const showMenuPermissionsBtn = document.getElementById('show-menu-permissions-btn');
            
            const usersSection = document.getElementById('users-section');
            const postsSection = document.getElementById('posts-section');
            const filesSection = document.getElementById('files-section');
            const inquiriesSection = document.getElementById('inquiries-section');
            const menuPermissionsSection = document.getElementById('menu-permissions-section');
            
            // 모든 섹션 숨기기
            function hideAllSections() {
                usersSection.style.display = 'none';
                postsSection.style.display = 'none';
                filesSection.style.display = 'none';
                inquiriesSection.style.display = 'none';
                menuPermissionsSection.style.display = 'none';
                
                // 모든 버튼 active 클래스 제거
                showUsersBtn.classList.remove('active');
                showPostsBtn.classList.remove('active');
                showFilesBtn.classList.remove('active');
                showInquiriesBtn.classList.remove('active');
                showMenuPermissionsBtn.classList.remove('active');
            }
            
            // 초기 화면: 모든 섹션 숨기기
            hideAllSections();
            usersSection.style.display = 'block';
            showUsersBtn.classList.add('active');
            
            // 회원 관리 섹션 표시
            showUsersBtn.addEventListener('click', function(e) {
                e.preventDefault();
                hideAllSections();
                usersSection.style.display = 'block';
                showUsersBtn.classList.add('active');
                loadUsers();
            });
            
            // 게시글 관리 섹션 표시
            showPostsBtn.addEventListener('click', function(e) {
                e.preventDefault();
                hideAllSections();
                postsSection.style.display = 'block';
                showPostsBtn.classList.add('active');
                loadPosts();
            });
            
            // 파일 관리 섹션 표시
            showFilesBtn.addEventListener('click', function(e) {
                e.preventDefault();
                hideAllSections();
                filesSection.style.display = 'block';
                showFilesBtn.classList.add('active');
                loadFiles();
            });
            
            // 문의 관리 섹션 표시
            showInquiriesBtn.addEventListener('click', function(e) {
                e.preventDefault();
                hideAllSections();
                inquiriesSection.style.display = 'block';
                showInquiriesBtn.classList.add('active');
                loadInquiries();
            });
            
            // 메뉴 권한 관리 섹션 표시
            showMenuPermissionsBtn.addEventListener('click', function(e) {
                e.preventDefault();
                hideAllSections();
                menuPermissionsSection.style.display = 'block';
                showMenuPermissionsBtn.classList.add('active');
                loadMenuPermissions();
            });
        });

        // 파일 삭제 함수
        function deleteFile(category, filename) {
            if (confirm(`정말로 '${filename}' 파일을 삭제하시겠습니까?`)) {
                fetch(`/delete/${category}/${filename}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('파일이 삭제되었습니다.');
                        loadFiles();
                    } else {
                        alert('파일 삭제에 실패했습니다: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('파일 삭제 중 오류가 발생했습니다.');
                });
            }
        }
        
        // 게시글 목록 로드 함수
        function loadPosts() {
            const postsContainer = document.getElementById('posts-container');
            postsContainer.innerHTML = '<p>로딩 중...</p>';
            
            fetch('/api/posts')
                .then(response => response.json())
                .then(posts => {
                    if (!Array.isArray(posts)) {
                        postsContainer.innerHTML = '<p>게시글 데이터를 불러오는데 실패했습니다.</p>';
                        return;
                    }
                    
                    if (posts.length === 0) {
                        postsContainer.innerHTML = '<p>등록된 게시글이 없습니다.</p>';
                        return;
                    }
                    
                    // 게시글 목록 테이블 생성
                    let html = `
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>제목</th>
                                    <th>작성자</th>
                                    <th>날짜</th>
                                    <th>첨부파일</th>
                                    <th>댓글 수</th>
                                    <th>관리</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    // 게시글을 최신순으로 정렬
                    posts.sort((a, b) => {
                        return new Date(b.date) - new Date(a.date);
                    });
                    
                    // 게시글 목록 추가
                    posts.forEach(post => {
                        html += `
                            <tr>
                                <td>${post.id}</td>
                                <td>${post.title}</td>
                                <td>${post.author}</td>
                                <td>${post.date}</td>
                                <td>${post.file ? `<a href="/uploads/posts/${post.file}" target="_blank">${post.file}</a>` : '없음'}</td>
                                <td>${post.comments ? post.comments.length : 0}개</td>
                                <td>
                                    <button class="view-post-btn" data-id="${post.id}">상세보기</button>
                                    <button class="delete-post-btn" data-id="${post.id}">삭제</button>
                                </td>
                            </tr>
                        `;
                    });
                    
                    html += `
                            </tbody>
                        </table>
                    `;
                    
                    postsContainer.innerHTML = html;
                    
                    // 상세보기 버튼 이벤트 등록
                    document.querySelectorAll('.view-post-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const postId = this.getAttribute('data-id');
                            const post = posts.find(p => p.id == postId);
                            if (post) {
                                showPostDetails(post);
                            }
                        });
                    });
                    
                    // 삭제 버튼 이벤트 등록
                    document.querySelectorAll('.delete-post-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const postId = this.getAttribute('data-id');
                            deletePost(postId);
                        });
                    });
                })
                .catch(error => {
                    console.error('Error:', error);
                    postsContainer.innerHTML = '<p>게시글 목록을 불러오는데 실패했습니다.</p>';
                });
        }
        
        // 게시글 삭제 함수
        function deletePost(postId) {
            if (confirm('정말로 이 게시글을 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.')) {
                fetch(`/api/posts/${postId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('게시글이 삭제되었습니다.');
                        loadPosts(); // 목록 다시 로드
                    } else {
                        alert('게시글 삭제에 실패했습니다: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('게시글 삭제 중 오류가 발생했습니다.');
                });
            }
        }
        
        // 게시글 상세 정보 표시 함수
        function showPostDetails(post) {
            // 모달 생성
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            
            // 모달 컨텐츠
            const modalContent = document.createElement('div');
            modalContent.className = 'modal-content';
            
            // 모달 헤더
            const modalHeader = document.createElement('div');
            modalHeader.className = 'modal-header';
            modalHeader.innerHTML = `
                <h3>${post.title} (ID: ${post.id})</h3>
                <span class="close">&times;</span>
            `;
            
            // 모달 바디
            const modalBody = document.createElement('div');
            modalBody.className = 'modal-body';
            
            // 게시글 본문 및 정보
            let postHtml = `
                <div class="post-details">
                    <p><strong>작성자:</strong> ${post.author}</p>
                    <p><strong>작성일:</strong> ${post.date}</p>
                    ${post.file ? `<p><strong>첨부파일:</strong> <a href="/uploads/posts/${post.file}" target="_blank">${post.file}</a></p>` : ''}
                    <div class="post-content">
                        ${post.content.replace(/\n/g, '<br>')}
                    </div>
                </div>
            `;
            
            // 댓글 섹션
            if (post.comments && post.comments.length > 0) {
                postHtml += `
                    <div class="comments-section">
                        <h4>댓글 (${post.comments.length})</h4>
                        <div class="comments-list">
                `;
                
                post.comments.forEach(comment => {
                    postHtml += `
                        <div class="comment">
                            <p><strong>${comment.author}</strong> <span class="comment-date">${comment.date}</span></p>
                            <p>${comment.content.replace(/\n/g, '<br>')}</p>
                        </div>
                    `;
                });
                
                postHtml += `
                        </div>
                    </div>
                `;
            } else {
                postHtml += `
                    <div class="comments-section">
                        <h4>댓글 (0)</h4>
                        <p>댓글이 없습니다.</p>
                    </div>
                `;
            }
            
            modalBody.innerHTML = postHtml;
            
            // 모달 푸터 (삭제 버튼 추가)
            const modalFooter = document.createElement('div');
            modalFooter.className = 'modal-footer';
            modalFooter.innerHTML = `
                <button class="modal-delete-btn" data-id="${post.id}">게시글 삭제</button>
            `;
            
            // 모달 조립
            modalContent.appendChild(modalHeader);
            modalContent.appendChild(modalBody);
            modalContent.appendChild(modalFooter);
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            // 닫기 버튼 이벤트
            const closeBtn = modal.querySelector('.close');
            closeBtn.addEventListener('click', function() {
                document.body.removeChild(modal);
            });
            
            // 삭제 버튼 이벤트
            const deleteBtn = modal.querySelector('.modal-delete-btn');
            deleteBtn.addEventListener('click', function() {
                const postId = this.getAttribute('data-id');
                document.body.removeChild(modal); // 모달 닫기
                deletePost(postId); // 삭제 함수 호출
            });
            
            // 모달 외부 클릭 시 닫기
            window.addEventListener('click', function(event) {
                if (event.target === modal) {
                    document.body.removeChild(modal);
                }
            });
        }
        
        // 문의 목록 로드 함수
        function loadInquiries() {
            const inquiriesContainer = document.getElementById('inquiries-container');
            inquiriesContainer.innerHTML = '<p>로딩 중...</p>';
            
            fetch('/api/inquiries')
                .then(response => response.json())
                .then(inquiries => {
                    if (!Array.isArray(inquiries)) {
                        inquiriesContainer.innerHTML = '<p>문의 데이터를 불러오는데 실패했습니다.</p>';
                        return;
                    }
                    
                    if (inquiries.length === 0) {
                        inquiriesContainer.innerHTML = '<p>등록된 문의가 없습니다.</p>';
                        return;
                    }
                    
                    // 문의 목록 테이블 생성
                    let html = `
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>이름</th>
                                    <th>연락처</th>
                                    <th>이메일</th>
                                    <th>행사 유형</th>
                                    <th>날짜</th>
                                    <th>장소</th>
                                    <th>접수일</th>
                                    <th>상태</th>
                                    <th>관리</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    // 문의를 최신순으로 정렬
                    inquiries.sort((a, b) => {
                        return new Date(b.created_at) - new Date(a.created_at);
                    });
                    
                    // 문의 목록 추가
                    inquiries.forEach(inquiry => {
                        const statusClass = 
                            inquiry.status === '접수됨' ? 'status-new' : 
                            inquiry.status === '처리중' ? 'status-processing' : 
                            inquiry.status === '완료' ? 'status-completed' : '';
                        
                        html += `
                            <tr>
                                <td>${inquiry.id}</td>
                                <td>${inquiry.name}</td>
                                <td>${inquiry.phone}</td>
                                <td>${inquiry.email}</td>
                                <td>${getEventTypeName(inquiry.event_type)}</td>
                                <td>${inquiry.date}</td>
                                <td>${inquiry.location}</td>
                                <td>${inquiry.created_at}</td>
                                <td>
                                    <select class="status-select" data-id="${inquiry.id}">
                                        <option value="접수됨" ${inquiry.status === '접수됨' ? 'selected' : ''}>접수됨</option>
                                        <option value="처리중" ${inquiry.status === '처리중' ? 'selected' : ''}>처리중</option>
                                        <option value="완료" ${inquiry.status === '완료' ? 'selected' : ''}>완료</option>
                                    </select>
                                </td>
                                <td>
                                    <button class="view-inquiry-btn" data-id="${inquiry.id}">상세보기</button>
                                    <button class="delete-inquiry-btn" data-id="${inquiry.id}">삭제</button>
                                </td>
                            </tr>
                        `;
                    });
                    
                    html += `
                            </tbody>
                        </table>
                    `;
                    
                    inquiriesContainer.innerHTML = html;
                    
                    // 상태 변경 이벤트 등록
                    document.querySelectorAll('.status-select').forEach(select => {
                        select.addEventListener('change', function() {
                            const inquiryId = this.getAttribute('data-id');
                            const newStatus = this.value;
                            updateInquiryStatus(inquiryId, newStatus);
                        });
                    });
                    
                    // 상세보기 버튼 이벤트 등록
                    document.querySelectorAll('.view-inquiry-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const inquiryId = this.getAttribute('data-id');
                            const inquiry = inquiries.find(inq => inq.id == inquiryId);
                            if (inquiry) {
                                showInquiryDetails(inquiry);
                            }
                        });
                    });
                    
                    // 삭제 버튼 이벤트 등록
                    document.querySelectorAll('.delete-inquiry-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const inquiryId = this.getAttribute('data-id');
                            deleteInquiry(inquiryId);
                        });
                    });
                })
                .catch(error => {
                    console.error('Error:', error);
                    inquiriesContainer.innerHTML = '<p>문의 목록을 불러오는데 실패했습니다.</p>';
                });
        }
        
        // 문의 삭제 함수
        function deleteInquiry(inquiryId) {
            if (confirm('정말로 이 문의를 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.')) {
                fetch(`/api/inquiries/${inquiryId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('문의가 삭제되었습니다.');
                        loadInquiries(); // 목록 다시 로드
                    } else {
                        alert('문의 삭제에 실패했습니다: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('문의 삭제 중 오류가 발생했습니다.');
                });
            }
        }
        
        // 행사 유형 이름 변환 함수
        function getEventTypeName(eventType) {
            const eventTypes = {
                'church': '교회 행사',
                'wedding': '결혼식',
                'concert': '콘서트',
                'etc': '기타'
            };
            return eventTypes[eventType] || eventType;
        }
        
        // 문의 상태 업데이트 함수
        function updateInquiryStatus(inquiryId, newStatus) {
            fetch(`/api/inquiries/${inquiryId}/status`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ status: newStatus })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('문의 상태가 업데이트되었습니다.');
                } else {
                    alert('문의 상태 업데이트에 실패했습니다: ' + data.error);
                    loadInquiries(); // 실패 시 목록 다시 로드
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('문의 상태 업데이트 중 오류가 발생했습니다.');
                loadInquiries(); // 오류 시 목록 다시 로드
            });
        }
        
        // 문의 상세 정보 표시 함수
        function showInquiryDetails(inquiry) {
            // 모달 생성
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            
            // 모달 컨텐츠
            const modalContent = document.createElement('div');
            modalContent.className = 'modal-content';
            
            // 모달 헤더
            const modalHeader = document.createElement('div');
            modalHeader.className = 'modal-header';
            modalHeader.innerHTML = `
                <h3>문의 상세 정보 (ID: ${inquiry.id})</h3>
                <span class="close">&times;</span>
            `;
            
            // 모달 바디
            const modalBody = document.createElement('div');
            modalBody.className = 'modal-body';
            modalBody.innerHTML = `
                <div class="inquiry-details">
                    <p><strong>이름:</strong> ${inquiry.name}</p>
                    <p><strong>연락처:</strong> ${inquiry.phone}</p>
                    <p><strong>이메일:</strong> ${inquiry.email}</p>
                    <p><strong>행사 유형:</strong> ${getEventTypeName(inquiry.event_type)}</p>
                    <p><strong>희망 날짜:</strong> ${inquiry.date}</p>
                    <p><strong>장소:</strong> ${inquiry.location}</p>
                    <p><strong>접수일:</strong> ${inquiry.created_at}</p>
                    <p><strong>상태:</strong> ${inquiry.status}</p>
                    <div class="inquiry-message">
                        <h4>문의 내용</h4>
                        <div class="message-content">
                            ${inquiry.message.replace(/\n/g, '<br>')}
                        </div>
                    </div>
                </div>
            `;
            
            // 모달 푸터 (삭제 버튼 추가)
            const modalFooter = document.createElement('div');
            modalFooter.className = 'modal-footer';
            modalFooter.innerHTML = `
                <button class="modal-delete-btn" data-id="${inquiry.id}">문의 삭제</button>
            `;
            
            // 모달 조립
            modalContent.appendChild(modalHeader);
            modalContent.appendChild(modalBody);
            modalContent.appendChild(modalFooter);
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            // 닫기 버튼 이벤트
            const closeBtn = modal.querySelector('.close');
            closeBtn.addEventListener('click', function() {
                document.body.removeChild(modal);
            });
            
            // 삭제 버튼 이벤트
            const deleteBtn = modal.querySelector('.modal-delete-btn');
            deleteBtn.addEventListener('click', function() {
                const inquiryId = this.getAttribute('data-id');
                document.body.removeChild(modal); // 모달 닫기
                deleteInquiry(inquiryId); // 삭제 함수 호출
            });
            
            // 모달 외부 클릭 시 닫기
            window.addEventListener('click', function(event) {
                if (event.target === modal) {
                    document.body.removeChild(modal);
                }
            });
        }
        
        // 파일 목록 로드 함수
        function loadFiles() {
            const filesContainer = document.getElementById('files-container');
            filesContainer.innerHTML = '<p>로딩 중...</p>';
            
            fetch('/check_files')
                .then(response => response.json())
                .then(data => {
                    if (data.status !== 'success') {
                        filesContainer.innerHTML = '<p>파일 데이터를 불러오는데 실패했습니다.</p>';
                        return;
                    }
                    
                    let html = '<h4>음악 파일</h4>';
                    
                    // AI 음악 파일
                    html += `
                        <div class="file-section">
                            <h5>AI 음원</h5>
                            <table class="admin-table">
                                <thead>
                                    <tr>
                                        <th>파일명</th>
                                        <th>관리</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    if (data.music.ai.length === 0) {
                        html += '<tr><td colspan="2">등록된 파일이 없습니다.</td></tr>';
                    } else {
                        data.music.ai.forEach(file => {
                            html += `
                                <tr>
                                    <td><a href="/uploads/music/ai/${file}" target="_blank">${file}</a></td>
                                    <td>
                                        <button class="delete-file-btn" onclick="deleteFile('music/ai', '${file}')">삭제</button>
                                    </td>
                                </tr>
                            `;
                        });
                    }
                    
                    html += `
                                </tbody>
                            </table>
                        </div>
                    `;
                    
                    // MR 음악 파일
                    html += `
                        <div class="file-section">
                            <h5>MR 음원</h5>
                            <table class="admin-table">
                                <thead>
                                    <tr>
                                        <th>파일명</th>
                                        <th>관리</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    if (data.music.mr.length === 0) {
                        html += '<tr><td colspan="2">등록된 파일이 없습니다.</td></tr>';
                    } else {
                        data.music.mr.forEach(file => {
                            html += `
                                <tr>
                                    <td><a href="/uploads/music/mr/${file}" target="_blank">${file}</a></td>
                                    <td>
                                        <button class="delete-file-btn" onclick="deleteFile('music/mr', '${file}')">삭제</button>
                                    </td>
                                </tr>
                            `;
                        });
                    }
                    
                    html += `
                                </tbody>
                            </table>
                        </div>
                    `;
                    
                    // Live 음악 파일
                    html += `
                        <div class="file-section">
                            <h5>Live 음원</h5>
                            <table class="admin-table">
                                <thead>
                                    <tr>
                                        <th>파일명</th>
                                        <th>관리</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    if (data.music.live.length === 0) {
                        html += '<tr><td colspan="2">등록된 파일이 없습니다.</td></tr>';
                    } else {
                        data.music.live.forEach(file => {
                            html += `
                                <tr>
                                    <td><a href="/uploads/music/live/${file}" target="_blank">${file}</a></td>
                                    <td>
                                        <button class="delete-file-btn" onclick="deleteFile('music/live', '${file}')">삭제</button>
                                    </td>
                                </tr>
                            `;
                        });
                    }
                    
                    html += `
                                </tbody>
                            </table>
                        </div>
                    `;
                    
                    // 악보 파일
                    html += `
                        <h4>악보 파일</h4>
                        <div class="file-section">
                            <table class="admin-table">
                                <thead>
                                    <tr>
                                        <th>파일명</th>
                                        <th>관리</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    if (data.scores.length === 0) {
                        html += '<tr><td colspan="2">등록된 파일이 없습니다.</td></tr>';
                    } else {
                        data.scores.forEach(file => {
                            html += `
                                <tr>
                                    <td><a href="/uploads/scores/${file}" target="_blank">${file}</a></td>
                                    <td>
                                        <button class="delete-file-btn" onclick="deleteFile('scores', '${file}')">삭제</button>
                                    </td>
                                </tr>
                            `;
                        });
                    }
                    
                    html += `
                                </tbody>
                            </table>
                        </div>
                    `;
                    
                    // 영상 파일
                    html += `
                        <h4>영상 파일</h4>
                        <div class="file-section">
                            <table class="admin-table">
                                <thead>
                                    <tr>
                                        <th>파일명</th>
                                        <th>관리</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    if (data.videos.length === 0) {
                        html += '<tr><td colspan="2">등록된 파일이 없습니다.</td></tr>';
                    } else {
                        data.videos.forEach(file => {
                            html += `
                                <tr>
                                    <td><a href="/uploads/videos/${file}" target="_blank">${file}</a></td>
                                    <td>
                                        <button class="delete-file-btn" onclick="deleteFile('videos', '${file}')">삭제</button>
                                    </td>
                                </tr>
                            `;
                        });
                    }
                    
                    html += `
                                </tbody>
                            </table>
                        </div>
                    `;
                    
                    filesContainer.innerHTML = html;
                })
                .catch(error => {
                    console.error('Error:', error);
                    filesContainer.innerHTML = '<p>파일 목록을 불러오는데 실패했습니다.</p>';
                });
        }

        // 메뉴 권한 관리 기능
        async function loadMenuPermissions() {
            try {
                const response = await fetch('/api/menu-permissions');
                if (!response.ok) {
                    throw new Error('메뉴 권한 정보를 가져오는데 실패했습니다.');
                }
                
                const data = await response.json();
                menuItems = data.menu_items;
                roleMenuPermissions = data.role_permissions;
                
                renderMenuPermissions();
            } catch (error) {
                console.error('메뉴 권한 로드 오류:', error);
                showMessage(error.message, 'error');
            }
        }
        
        function renderMenuPermissions() {
            const container = document.getElementById('role-menu-permissions');
            container.innerHTML = '';
            
            // 각 역할별 메뉴 권한 설정 UI 생성
            Object.keys(USER_ROLES).forEach(role => {
                const rolePermissions = roleMenuPermissions[role] || [];
                const isAdmin = role === 'admin';
                
                const roleSection = document.createElement('div');
                roleSection.className = 'role-menu-grid';
                
                // 역할 이름
                const roleName = document.createElement('div');
                roleName.className = 'role-name';
                roleName.innerHTML = `<span class="permission-badge ${role}">${USER_ROLES[role]}</span>`;
                
                // 메뉴 체크박스 컨테이너
                const menuCheckboxes = document.createElement('div');
                menuCheckboxes.className = 'menu-checkboxes';
                
                // 각 메뉴 아이템에 대한 체크박스 생성
                menuItems.forEach(menuItem => {
                    const isSelected = rolePermissions.includes(menuItem.id);
                    const isLocked = isAdmin && (menuItem.id === 'about' || menuItem.id === 'admin');
                    
                    const checkboxItem = document.createElement('div');
                    checkboxItem.className = `menu-checkbox-item ${isSelected ? 'selected' : ''} ${isLocked ? 'locked' : ''}`;
                    checkboxItem.dataset.role = role;
                    checkboxItem.dataset.menuId = menuItem.id;
                    checkboxItem.textContent = menuItem.name;
                    
                    // 관리자는 모든 메뉴 접근 가능하고 특정 메뉴는 잠금 처리
                    if (!isLocked) {
                        checkboxItem.addEventListener('click', function() {
                            // admin 역할은 수정 불가
                            if (role === 'admin') return;
                            
                            // about 메뉴는 항상 활성화되어야 함
                            if (menuItem.id === 'about') return;
                            
                            this.classList.toggle('selected');
                        });
                    }
                    
                    menuCheckboxes.appendChild(checkboxItem);
                });
                
                roleSection.appendChild(roleName);
                roleSection.appendChild(menuCheckboxes);
                container.appendChild(roleSection);
            });
        }
        
        // 메뉴 권한 저장
        document.getElementById('save-menu-permissions').addEventListener('click', async function() {
            try {
                // 현재 UI에서 선택된 메뉴 권한 수집
                const newPermissions = {};
                
                Object.keys(USER_ROLES).forEach(role => {
                    const menuItems = document.querySelectorAll(`.menu-checkbox-item[data-role="${role}"]`);
                    
                    // admin 역할은 모든 메뉴 접근 가능 (변경 불가)
                    if (role === 'admin') {
                        newPermissions[role] = roleMenuPermissions[role];
                        return;
                    }
                    
                    newPermissions[role] = Array.from(menuItems)
                        .filter(item => item.classList.contains('selected') || item.dataset.menuId === 'about')
                        .map(item => item.dataset.menuId);
                });
                
                // 서버로 업데이트 요청
                const response = await fetch('/api/menu-permissions/update', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ permissions: newPermissions })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showMessage('메뉴 권한이 저장되었습니다.', 'success');
                    // 권한 다시 로드
                    loadMenuPermissions();
                } else {
                    throw new Error(data.error || '권한 저장에 실패했습니다.');
                }
            } catch (error) {
                console.error('메뉴 권한 저장 오류:', error);
                showMessage(error.message, 'error');
            }
        });
    </script>
    <script src="js/menu-permissions.js"></script>
</body>
</html> 